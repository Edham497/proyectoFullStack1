let express,Product,User,SERVER_ERROR,WRITE_JSON,NOT_FOUND,WRITE_DATA,WRITE_OK;_8c3‍.x([["default",()=>_8c3‍.o]]);_8c3‍.w("express",[["default",["express"],function(v){express=v}]]);_8c3‍.w("../models/product",[["default",["Product"],function(v){Product=v}]]);_8c3‍.w("../models/user",[["default",["User"],function(v){User=v}]]);_8c3‍.w("../models/ResponseHandler",[["SERVER_ERROR",["SERVER_ERROR"],function(v){SERVER_ERROR=v}],["WRITE_JSON",["WRITE_JSON"],function(v){WRITE_JSON=v}],["NOT_FOUND",["NOT_FOUND"],function(v){NOT_FOUND=v}],["WRITE_DATA",["WRITE_DATA"],function(v){WRITE_DATA=v}],["WRITE_OK",["WRITE_OK"],function(v){WRITE_OK=v}]]);





async function asyncForEach(array, callback) {
    for (let index = 0; index < array.length; index++) {
        await callback(array[index], index, array);
    }
}

const router = express.Router()

router.get('/', async (request, response) => {
    const listaProducts = await Product.find({})
    if (listaProducts.length < 2)
        WRITE_JSON(response, listaProducts[0])
    else
        WRITE_JSON(response, listaProducts)
})

router.post('/add', async (request, response) => {
    const product = new Product(request.body)
    await product.save()
    WRITE_JSON(response, { status: 'OK' })
})

router.put('/edit', async (request, response) => {
    const { productToChange, data } = request.body
    const res = await Product.updateOne({ _id: productToChange }, { $set: data })
    WRITE_JSON(response, { status: 'OK', backlog: JSON.stringify(res) })
})

// router.delete('/delete', async(request, response) => {
//     const productoToDelete = request.body
//     const res = await Product.deleteOne()
// })

router.get('/find', async (request, response) => {
    try {
        const product = await Product.findById(request.body)
        if (product)
            WRITE_JSON(response, { status: 'OK', product })
        else
            NOT_FOUND(response, 'Producto no encontrado')
    } catch (e) {
        SERVER_ERROR(response)
    }
})


router.post('/findList', async (request, response) => {
    const products = request.body
    let list = []
    await asyncForEach(products, async product => {
        try {
            const _produc = await Product.findById(product)
            list.push(_produc)
        } catch (e) {
            SERVER_ERROR(response)
        }
    })
    WRITE_DATA(response, list)
})

router.post('/addToCart', async (request, response) => {
    try {
        const { userID, product } = request.body
        _8c3‍.g.console.log(product)
        await User.findByIdAndUpdate(userID, { $pull: { "carrito.$.producto": product.producto } })
        await User.findByIdAndUpdate(userID, { $push: { carrito: product } })
        WRITE_OK(response)
    } catch (e) {
        _8c3‍.g.console.log(e)
        SERVER_ERROR(response, e)
    }
})

_8c3‍.d(router);